<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js'></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
<head>
    <meta charset="UTF-8">
    <title>ğŸ§‘ğŸ»â€â¤ï¸â€ğŸ§‘ğŸ»coupleDiaryğŸ§‘ğŸ»â€â¤ï¸â€ğŸ§‘ğŸ»</title></head>
<body>
<div id="body-frame"> <!-- ë¡œê·¸ì¸ ì•ˆ í•œ ì‚¬ìš©ì --> <a href="/loginPage" sec:authorize="isAnonymous()">ë¡œê·¸ì¸</a> <!-- ë¡œê·¸ì¸ í•œ ì‚¬ìš©ì -->
    <a href="/logout" sec:authorize="isAuthenticated()">ë¡œê·¸ì•„ì›ƒ</a></div>
<div id="demo-mobile-month-view"></div> <!-- ë‹¬ë ¥ --> <!-- í”Œë˜ì‹œ ë©”ì‹œì§€ ì¶œë ¥ -->
<div th:if="${msg}" class="alert alert-success" th:text="${msg}"></div>
<div id='calendar'></div>
<div class="modal fade" id="diaryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form id="diaryForm" class="modal-content">
            <div class="modal-header"><h5 class="modal-title">ì¼ê¸° ì‘ì„± <span id="modalDateLabel"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body"><input type="hidden" id="diaryId"/> <input type="hidden" id="diaryDate"/>
                <div class="mb-3"><label class="form-label">ë‚ ì”¨</label> <input id="weatherInput" class="form-control"/>
                </div>
                <div class="mb-3"><label class="form-label">ê¸°ì˜¨</label> <input id="tempInput" type="number" step="0.1"
                                                                              class="form-control"/></div>
                <div class="mb-3"><label class="form-label">ê¸°ë¶„</label> <select id="moodInput" class="form-select">
                    <option value="">ì„ íƒ</option>
                    <option>ì¢‹ìŒ</option>
                    <option>ë³´í†µ</option>
                    <option>ë‚˜ì¨</option>
                </select></div>
                <div class="mb-3"><label class="form-label">ë‚´ìš©</label> <textarea id="contentInput" rows="6"
                                                                                 class="form-control"></textarea></div>
            </div>
            <div class="modal-footer">
                <button type="button" id="deleteBtn" class="btn btn-danger" style="display:none">ì‚­ì œ</button>
                gg
                <button type="submit" class="btn btn-primary">ì €ì¥</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
            </div>
        </form>
    </div>
</div>
<script> document.addEventListener('DOMContentLoaded', function () {
    var calendarEl = document.getElementById('calendar');
    const modal = new bootstrap.Modal(document.getElementById('diaryModal'));

    async function isAuthenticated() {
        const res = await fetch("/CheckAuth", {
            method: 'GET',
            credentials: 'include', // ì¿ í‚¤ ìë™ í¬í•¨ (JWTê°€ ì¿ í‚¤ì— ìˆìœ¼ë‹ˆê¹Œ í•„ìˆ˜)
            headers: {'Accept': 'application/json'}
        });
        console.log("[CheckAuth]: " + res.status);
        return res.ok;


    }

    form
    inputs
    const idInput = document.getElementById('diaryId');
    const dateInput = document.getElementById('diaryDate');
    const dateLabel = document.getElementById('modalDateLabel');
    const weatherInput = document.getElementById('weatherInput');
    const tempInput = document.getElementById('tempInput');
    const moodInput = document.getElementById('moodInput');
    const contentInput = document.getElementById('contentInput');
    const deleteBtn = document.getElementById('deleteBtn');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth', dateClick: async (info) => {
            const authed = await isAuthenticated();
            if (!authed) {
                if (confirm("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤. ë¡œê·¸ì¸í˜ì´ì§€ë¡œ ì´ë™í• ê¹Œìš”?")) {
                    location.href = "/loginPage";
                }
                return;
            }

            //ê¸€ ìˆëŠ” ì§€ ì—†ëŠ”ì§€ ì—¬ë¶€ë„ ì²´í¬
            const clickedDate = info.dateStr;//YYYY - MM - DD
            console.log("cc" + clickedDate);
            dateLabel.textContent = clickedDate;
            dateInput.value = clickedDate;
            idInput.value = '';
            deleteBtn.style.display = 'none';
            contentInput.value = '';
            moodInput.value = '';
            tempInput.value = '';
            weatherInput.value = '';
            //ì„œë²„ì—ì„œ ë‚ ì”¨ ì •ë³´ê°€ì ¸ì˜¤ê¸°
            try { const w = await fetch('/diary/getWeather?date=${clickedDate}', { credentials: 'include', });
                console.log(clickedDate);
                if (w.ok) {
                    const data = await w.json();
                    console.log("ê°€ì ¸ì˜¨ ë°ì´í„°" + data);
                    // 1) OpenWeatherMap ì›ë³¸(JSON) í˜•íƒœ ëŒ€ì‘
                    const owWeather = data?.weather?.[0]?.main;
                    const owTempK = data?.main?.temp;
                    const owTempC = typeof owTempK === 'number' ? +(owTempK - 273.15).toFixed(1) : null;
                    /* // 2) ì„œë²„ê°€ DateWeather/DTOë¡œ ë‚´ë ¤ì¤„ ìˆ˜ë„ ìˆì„ ë•Œ(ë°±ì—”ë“œê°€ ë°”ë€Œì–´ë„ ì•ˆì „í•˜ê²Œ)
                    const dtoWeather = data?.weather || data?.main; // ex) "Clear" or "Clouds"
                    const dtoTempC = (typeof data?.temperature === 'number')
                    ? data.temperature : (typeof data?.temp === 'number')
                    ? data.temp : null; */
                // 3) ìµœì¢… ê°’ ì„ íƒ(ì›ë³¸ ìš°ì„ , ì—†ìœ¼ë©´ DTO ê°’)
                    const weatherVal = owWeather ?? dtoWeather ?? 'ì •ë³´ì—†ìŒ';
                    const tempVal = (owTempC ?? dtoTempC);
                    weatherInput.value = weatherVal;
                    tempInput.value = (tempVal != null) ? tempVal : 'ì •ë³´ì—†ìŒ';
                }
            } catch (err) {
                console.log(err);
                alert("ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤");
            }
            modal.show();
        }
    });
    calendar.render();
    document.getElementById("diaryForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const diaryData = {
            date: dateInput.value,
            weather: weatherInput.value,
            temperature: parseFloat(tempInput.value) || 0,
            mood: moodInput.value,
            content: contentInput.value
        };
        try {
            const res = await fetch("/diary/save", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(diaryData),
                credentials: 'include'
            });
            if (res.ok) {
                alert("ì €ì¥ ì„±ê³µ!");
                modal.hide();
                calendar.refetchEvents(); // ì´ë²¤íŠ¸ ë‹¤ì‹œ ë¡œë“œ } else { alert("ì €ì¥ ì‹¤íŒ¨"); } } catch (err) { console.error(err); alert("ì—ëŸ¬ ë°œìƒ!"); } }); }); </script>
</body>
</html>