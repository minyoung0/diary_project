<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js'></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>

<head>
    <meta charset="UTF-8">
    <title>ğŸ§‘ğŸ»â€â¤ï¸â€ğŸ§‘ğŸ»coupleDiaryğŸ§‘ğŸ»â€â¤ï¸â€ğŸ§‘ğŸ»</title>
    <style>
        body {
            background: #f8f8f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Noto Sans KR', sans-serif;
        }

        .main-container {
            display: grid;
            grid-template-columns: 6fr 4fr;
            width: 80%;
            min-height: 600px;
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(255, 184, 150, 0.3);
            overflow: hidden;
        }

        /* Calendar */
        .calendar-container {
            padding: 24px;
            border-right: 1px solid #eee;
            display: flex;
            flex-direction: column;
        }

        #calendar {
            flex: 1;
            min-height: 600px;
            border-radius: 12px;
            overflow: hidden;
        }

        .fc-event {
            background-color: #ffb896 !important;
            border: none !important;
            color: white !important;
            font-size: 12px;
            border-radius: 6px;
        }

        /* Profile */
        .profile-container {
            background: linear-gradient(180deg, #fef6f1 0%, #fff6f9 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 24px;
            padding: 24px;
        }

        .profile-pair {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .person {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .person img {
            width: 96px;
            height: 96px;
            border-radius: 50%;
            border: 4px solid #ffb896;
            object-fit: cover;
        }

        .heart {
            font-size: 36px;
            color: #ff7b9c;
            text-shadow: 0 0 8px rgba(255, 123, 156, 0.4);
        }

        .days-counter {
            text-align: center;
        }

        .days-counter p {
            margin: 0;
        }

        /* Modal ìŠ¤íƒ€ì¼ */
        .mood-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .mood-button {
            background: #fff6f1;
            border: 1px solid #ffb896;
            border-radius: 10px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .mood-button:hover {
            background: #ffe4d6;
        }

        .mood-emoji {
            font-size: 22px;
            display: block;
        }

        .button-row {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 16px;
        }

        .btn-cancel {
            background: #ccc;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
        }

        .btn-save {
            background: #ffb896;
            color: #5a3a2a;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
        }

        .btn-save:hover {
            background: #ffd3b5;
        }

        .mood-button.active {
            background: #ffb896;
            color: #fff;
            border: 1px solid #ff7b9c;
        }

        .fc-daygrid-day-number {
            color: #d17e5a !important; /* ì›í•˜ëŠ” ìƒ‰ìƒ */
            font-weight: 600;
        }

        .fc-col-header-cell-cushion {
            color: rgb(211, 130, 53) !important;
            font-weight: bold;
        }

        .fc-event {
            background-color: #ffb896 !important;
            border: none !important;
            color: #5a3a2a !important; /* ê¸°ì¡´ white ëŒ€ì‹  ê°ˆìƒ‰ ê¸€ì */
            font-size: 12px;
            border-radius: 6px;
        }
    </style>
</head>

<body>

<div class="main-container">
    <div class="calendar-container">
        <div id="calendar"></div>
    </div>
    <div class="profile-container">
        <h4>ìš°ë¦¬ì˜ ì»¤í”Œ ë‹¤ì´ì–´ë¦¬</h4>
        <div class="profile-pair">
            <div class="person">
                <img id="person1Img" src="https://via.placeholder.com/96"/>
                <p id="person1Name">ì´ë¦„1</p>
            </div>
            <div class="heart">â¤</div>
            <div class="person">
                <img id="person2Img" src="https://via.placeholder.com/96"/>
                <p id="person2Name">ì´ë¦„2</p>
            </div>
        </div>
        <div class="days-counter">
            <p class="text-muted">í•¨ê»˜í•œ ì§€</p>
            <p id="dayCount" class="fs-4 fw-bold">0ì¼</p>
        </div>

        <div class="d-flex flex-column align-items-center gap-2 mt-3" id="profileButtons">
            <a href="/loginPage" id="loginBtn" class="btn btn-outline-primary btn-sm w-100"
               style="display:none;">ë¡œê·¸ì¸</a>
            <button id="logoutBtn" class="btn btn-outline-danger btn-sm w-100" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
            <a href="/editUserPage" id="myPageBtn" class="btn btn-outline-secondary btn-sm w-100" style="display:none;">ë‚´
                ì •ë³´ ìˆ˜ì •</a>
            <button class="btn btn-outline-success btn-sm w-100" data-bs-toggle="modal"
                    data-bs-target="#inviteModal" id="inviteBtn" style="display:none;">
                ğŸ’Œ ì»¤í”Œ ì—°ê²°í•˜ê¸°
            </button>
        </div>
    </div>
</div>

<!-- ì¼ê¸°ì‘ì„± ëª¨ë‹¬ -->
<div class="modal fade" id="diaryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form id="diaryForm" class="modal-content p-3">
            <input type="hidden" id="diaryId"/>
            <div class="modal-header">
                <h5 class="modal-title">ì¼ê¸° ì‘ì„± <span id="modalDateLabel"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label>ë‚ ì”¨</label>
                <select id="weatherSelect" class="form-select mb-2">
                    <option value="">ì„ íƒ</option>
                    <option value="sunny">â˜€ï¸ ë§‘ìŒ</option>
                    <option value="cloudy">â˜ï¸ íë¦¼</option>
                    <option value="rainy">ğŸŒ§ï¸ ë¹„</option>
                    <option value="snowy">â„ï¸ ëˆˆ</option>
                </select>
                <label>ê¸°ì˜¨ (Â°C)</label>
                <input type="number" id="tempInput" class="form-control mb-2" placeholder="25"/>

                <label>ì˜¤ëŠ˜ì˜ ê¸°ë¶„</label>
                <div class="mood-grid">
                    <div id="moodButtons" class="mood-grid">

                        <div class="mood-button"><span class="mood-emoji">ğŸ˜Š</span>ì¢‹ìŒ</div>
                        <div class="mood-button"><span class="mood-emoji">ğŸ˜Œ</span>í‰ì˜¨</div>
                        <div class="mood-button"><span class="mood-emoji">ğŸ¥°</span>ì„¤ë ˜</div>
                        <div class="mood-button"><span class="mood-emoji">ğŸ˜†</span>ì‹ ë‚¨</div>
                        <div class="mood-button"><span class="mood-emoji">ğŸ˜¢</span>ìŠ¬í””</div>
                        <div class="mood-button"><span class="mood-emoji">ğŸ˜ </span>í™”ë‚¨</div>
                    </div>
                </div>
                <span id="moodDisplay" class="text-muted" style="display:none;"></span>
                <label class="mt-3">ë‚´ìš©</label>
                <textarea id="contentInput" rows="5" class="form-control" placeholder="ì˜¤ëŠ˜ ìˆì—ˆë˜ ì¼ì„ ì ì–´ë³´ì„¸ìš”..."></textarea>
            </div>

            <div class="modal-footer">
                <button type="button" id="editBtn" class="btn btn-warning" style="display:none">ìˆ˜ì •</button>
                <button type="button" id="deleteBtn" class="btn btn-danger" style="display:none">ì‚­ì œ</button>
                <button type="submit" class="btn btn-save">ì €ì¥</button>
                <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">ì·¨ì†Œ</button>
            </div>

            <div id="commentSection" class="mt-2" style="display:none">
                <hr>
                <h6>ëŒ“ê¸€</h6>
                <div id="commentList" class="mb-3"></div>
                <!-- ëŒ“ê¸€ ì…ë ¥ -->
                <div id="commentForm" class="input-group">
                    <input type="text" id="commentInput" class="form-control" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”...">
                    <button type="button" id="commentSubmit" class="btn btn-outline-primary">ë“±ë¡</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- ì»¤í”Œì—°ë™ ëª¨ë‹¬ -->
<div class="modal fade" id="inviteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì»¤í”Œ ì—°ê²°í•˜ê¸°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body"><input type="hidden" id="diaryDate"/>
                <div id="inviteSection">
                    <button id="generateInviteBtn" class="btn btn-success w-100">ì´ˆëŒ€ì½”ë“œ ë°œê¸‰</button>
                    <p id="inviteCodeDisplay" class="mt-3 text-center fw-bold"></p>
                </div>
                <hr>
                <div id="acceptSection">
                    <input type="text" id="inviteCodeInput" class="form-control" placeholder="ì´ˆëŒ€ì½”ë“œ ì…ë ¥">
                    <button id="acceptInviteBtn" class="btn btn-primary w-100 mt-2">ì—°ê²°í•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>

    // ë¹„ë™ê¸°
    document.addEventListener("DOMContentLoaded", async () => {
        let islogin = false;
        let currentUser = null;
        try {
            const res = await fetch("/CheckAuth", {credentials: "include"});
            if (res.ok) {
                //document.getElementById("logoutBtn").style.display = "inline";
                const data = await res.json();
                console.log("auth:" + data);

                islogin = true;
                currentUser = data.userId;
                document.getElementById("myPageBtn").style.display = "inline";
                document.getElementById("logoutBtn").style.display = "inline";
                const myImg = data.profileImg || "/profileImg/img.png";
                document.getElementById("person1Img").src = myImg;
                document.getElementById("person1Name").textContent = data.nickname;

                // ì»¤í”Œì´ ì—†ì„ ë•Œ
                if (!data.coupleId || data.coupleId === 0) {
                    document.getElementById("inviteBtn").style.display = "inline";
                    document.getElementById("person2Img").src = "/profileImg/img.png";
                    document.getElementById("person2Name").textContent = "ì»¤í”Œì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤";
                    document.getElementById("dayCount").textContent = "0ì¼";
                }
                // ì»¤í”Œì¼ ë•Œ
                else {
                    document.getElementById("inviteBtn").style.display = "none";
                    const partnerImg = data.partnerProfileImg || "/profileImg/img.png";
                    document.getElementById("person2Img").src = partnerImg;
                    document.getElementById("person2Name").textContent = data.partnerNickname;
                    document.getElementById("dayCount").textContent = `${data.dayCount}ì¼`;
                }
            } else {
                handleNotLoggedIn();

            }
        } catch (e) {
            console.error(e);
            handleNotLoggedIn();
        }

        function handleNotLoggedIn() {
            document.getElementById("loginBtn").style.display = "inline";
            document.getElementById("logoutBtn").style.display = "none";
            document.getElementById("inviteBtn").style.display = "none";
            document.getElementById("person1Name").textContent = "ë¡œê·¸ì¸";
            document.getElementById("person2Name").textContent = "í•˜ì„¸ìš”";
            document.getElementById("dayCount").textContent = "ğŸ’Œ";

            const ts = Date.now();
            document.getElementById("person1Img").src = `/profileImg/img.png?t=${ts}`;
            document.getElementById("person2Img").src = `/profileImg/img.png?t=${ts}`;
        }


        var calendarEl = document.getElementById('calendar');
        const modal = new bootstrap.Modal(document.getElementById('diaryModal'));
        // input í¼
        const idInput = document.getElementById('diaryId');
        const dateInput = document.getElementById('diaryDate');
        const dateLabel = document.getElementById('modalDateLabel');
        const weatherInput = document.getElementById('weatherSelect');
        const tempInput = document.getElementById('tempInput');
        const contentInput = document.getElementById('contentInput');
        const deleteBtn = document.getElementById('deleteBtn');
        const editBtn = document.getElementById("editBtn");
        const commentSection = document.getElementById("commentSection");

        const eventSource = islogin ? '/diary/events' : [];
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            events: eventSource,
            eventDisplay: 'block',
            eventTextColor: '#fff',
            eventBackgroundColor: '#f68bb5',
            eventClick: function (info) {
                // í´ë¦­í–ˆì„ ë•Œ ìƒì„¸ ëª¨ë‹¬ ë„ìš°ê¸°
                const diaryId = info.event.id;
                fetch(`/diary/getDiary/${diaryId}`)
                    .then(res => res.json())
                    .then(diary => {
                        dateLabel.textContent = diary.date;
                        dateInput.value = diary.date;
                        idInput.value = diary.diaryId;
                        contentInput.value = diary.content;
                        selectedMood = diary.mood;
                        tempInput.value = diary.temperature;
                        weatherInput.value = diary.weather;

                        const moodDisplay = document.getElementById("moodDisplay");
                        moodDisplay.textContent = `${diary.mood || 'ì •ë³´ ì—†ìŒ'}`;
                        moodDisplay.style.display = "block";
                        moodButtons.forEach(b => b.style.display = "none");

                        moodButtons.forEach(b => {
                            if (b.textContent.trim() === diary.mood) b.classList.add("active");
                            else b.classList.remove("active");
                        });

                        if (diary.userId === currentUser) {
                            editBtn.style.display = 'block';
                            deleteBtn.style.display = 'block';
                        } else {
                            editBtn.style.display = 'none';
                            deleteBtn.style.display = 'none';
                        }

                        document.querySelector('.btn-save').style.display = 'none';
                        document.querySelector('.btn-cancel').style.display = 'block';
                        commentSection.style.display = 'block';
                        //ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
                        loadComments(diaryId);
                        modal.show();

                        // ì½ê¸° ì „ìš© ëª¨ë“œ
                        dateInput.setAttribute("readonly", true);
                        contentInput.setAttribute("readonly", true);
                        tempInput.setAttribute("readonly", true);
                        weatherInput.setAttribute("disabled", true);
                        moodButtons.forEach(b => b.setAttribute("disabled", true));
                    });
            },
            dateClick: async (info) => {
                dateInput.removeAttribute("readonly");
                contentInput.removeAttribute("readonly");
                tempInput.removeAttribute("readonly");
                weatherInput.removeAttribute("disabled");
                moodButtons.forEach(b => {
                    b.removeAttribute("disabled");
                    b.style.display = "block";
                });
                document.getElementById("moodDisplay").style.display = "none";

                const authed = await isAuthenticated();
                if (!authed) {
                    if (confirm("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤. ë¡œê·¸ì¸í˜ì´ì§€ë¡œ ì´ë™í• ê¹Œìš”?")) {
                        location.href = "/loginPage";
                    }
                    return;
                }

                const clickedDate = info.dateStr;
                dateLabel.textContent = clickedDate;
                dateInput.value = clickedDate;
                idInput.value = '';
                contentInput.value = '';
                selectedMood = '';
                moodButtons.forEach(b => b.classList.remove("active"));
                tempInput.value = '';
                weatherInput.value = '';

                editBtn.style.display = 'none';
                deleteBtn.style.display = 'none';
                document.querySelector('.btn-save').style.display = 'block';
                document.querySelector('.btn-cancel').style.display = 'block';

                const weatherData = await fetchWeatherData(clickedDate);
                weatherInput.value = weatherData.weather;
                tempInput.value = weatherData.temperature;
                modal.show();
            }
        });
        calendar.render();

        async function isAuthenticated() {
            const res = await fetch("/CheckAuth", {
                method: 'GET', credentials: 'include', // ì¿ í‚¤ ìë™ í¬í•¨ (JWTê°€ ì¿ í‚¤ì— ìˆìœ¼ë‹ˆê¹Œ í•„ìˆ˜)
                headers: {'Accept': 'application/json'}
            });
            if (res.ok) {
                const data = await res.json();
                currentUser = data.userId;
            }
            console.log("[CheckAuth]: " + res.status);
            return res.ok;
        }

        async function fetchWeatherData(clickedDate) {
            try {
                const w = await fetch(`/diary/getWeather?date=${clickedDate}&t=${Date.now()}`, {
                    credentials: 'include',
                    cache: 'no-store' // ë¸Œë¼ìš°ì €ê°€ ì‘ë‹µì„ ìºì‹œì— ì €ì¥í•˜ì§€ ì•ŠìŒ
                });
                if (w.ok) {
                    const data = await w.json();
                    console.log("ê°€ì ¸ì˜¨ ë°ì´í„°" + data);

                    const owWeather = data?.weather?.[0]?.main;
                    const owTempK = data?.main?.temp;
                    const owTempC = typeof owTempK === 'number' ? +(owTempK - 273.15).toFixed(1) : null;
                    const dtoWeather = data?.weather || data?.main;
                    const dtoTempC = (typeof data?.temperature === 'number') ? data.temperature
                        : (typeof data?.temp === 'number') ? data.temp : null;

                    const weatherVal = owWeather ?? dtoWeather ?? 'ì •ë³´ì—†ìŒ';
                    const tempVal = (owTempC ?? dtoTempC);


                    const weatherMap = {
                        'Clear': 'sunny',
                        'sunny': 'sunny',
                        'Rain': 'rainy',
                        'rainy': 'rainy',
                        'Clouds': 'cloudy',
                        'cloudy': 'cloudy',
                        'Snow': 'snowy',
                        'snowy': 'snowy'
                    };

                    if (weatherVal && weatherMap[weatherVal]) {
                        weatherInput.value = weatherMap[weatherVal];
                    } else {
                        weatherInput.value = '';
                    }

                    const weather = weatherVal && weatherMap[weatherVal] ? weatherMap[weatherVal] : '';
                    const temperature = (tempVal != null) ? tempVal : 'ì •ë³´ì—†ìŒ';

                    return {weather, temperature};
                }
            } catch (err) {
                console.log(err);
                alert("ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤");
            }
        }

        //ê¸°ë¶„ ì„ íƒ
        let selectedMood = "";
        const moodButtons = document.querySelectorAll(".mood-button");

        moodButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                // ê¸°ì¡´ ì„ íƒ í•´ì œ
                moodButtons.forEach(b => b.classList.remove("active"));
                // í´ë¦­í•œ ë²„íŠ¼ ê°•ì¡°
                btn.classList.add("active");

                // ì„ íƒí•œ ê¸°ë¶„ í…ìŠ¤íŠ¸ ì €ì¥
                selectedMood = btn.textContent.trim();
                console.log("ì„ íƒí•œ ê¸°ë¶„:", selectedMood);
            });
        });
        // ì´ˆëŒ€ì½”ë“œ ë°œê¸‰
        document.getElementById("generateInviteBtn").addEventListener("click", async () => {
            const res = await fetch("/couple/invite", {method: "POST", credentials: "include"});
            if (res.ok) {
                const code = await res.text();
                document.getElementById("inviteCodeDisplay").innerText = "ğŸ“¢ ì´ˆëŒ€ì½”ë“œ: " + code;
            } else {
                alert("ì´ˆëŒ€ì½”ë“œ ë°œê¸‰ ì‹¤íŒ¨");
            }
        });

        // ì´ˆëŒ€ì½”ë“œ ì…ë ¥ â†’ ì—°ê²°
        document.getElementById("acceptInviteBtn").addEventListener("click", async () => {
            const code = document.getElementById("inviteCodeInput").value;
            if (!code) {
                alert("ì´ˆëŒ€ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”");
                return;
            }

            const res = await fetch("/couple/accept?code=" + code, {method: "POST", credentials: "include"});
            const msg = await res.text();
            if (res.ok) {
                alert(msg);
                location.reload();
            } else {
                alert(msg);
            }

        });


        document.getElementById("diaryForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const diaryData = {
                diaryId: idInput.value || null,
                date: dateInput.value,
                weather: weatherInput.value,
                temperature: parseFloat(tempInput.value) || 0,
                mood: selectedMood,
                content: contentInput.value,
                userId: currentUser
            };
            const url = diaryData.diaryId ? "/diary/update" : "/diary/save";
            try {
                const res = await fetch(url, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(diaryData),
                    credentials: 'include'
                });

                if (res.ok) {
                    alert(diaryData.diaryId ? "ìˆ˜ì • ì™„ë£Œ!" : "ì €ì¥ ì™„ë£Œ!");
                    modal.hide();
                    calendar.refetchEvents();
                } else {
                    alert("ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
                }
            } catch (err) {
                console.error(err);
                alert("ì—ëŸ¬ ë°œìƒ!");
            }
        });
        document.getElementById("logoutBtn").addEventListener("click", async (e) => {
            e.preventDefault();
            const res = await fetch("/logout", {
                method: "GET",
                credentials: "include"
            });
            if (res.ok) {
                alert("ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ!");
                handleNotLoggedIn();
                location.reload(true); // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
            } else {
                alert("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨");
            }
        });

        deleteBtn.addEventListener("click", async () => {
            if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            const diaryId = idInput.value;
            if (!diaryId) return;

            const res = await fetch(`/diary/delete/${diaryId}`, {
                method: "POST",
                credentials: "include"
            });

            if (res.ok) {
                alert("ì‚­ì œ ì™„ë£Œ!");
                modal.hide();
                calendar.refetchEvents();
            } else {
                alert("ì‚­ì œ ì‹¤íŒ¨");
            }
        });

        editBtn.addEventListener("click", () => {
            dateInput.removeAttribute("readonly");
            contentInput.removeAttribute("readonly");
            tempInput.removeAttribute("readonly");
            weatherInput.removeAttribute("disabled");

            moodButtons.forEach(b => {
                b.style.display = "block";
                b.removeAttribute("disabled");
            });
            document.getElementById("moodDisplay").style.display = "none";

            editBtn.style.display = "none";
            deleteBtn.style.display = "block";
            document.querySelector('.btn-save').style.display = 'block';
        });

        // ëŒ“ê¸€ ë“±ë¡
        document.getElementById("commentSubmit").addEventListener("click", async (e) => {
            const diaryId = document.getElementById("diaryId").value;
            const comment = document.getElementById("commentInput").value.trim();
            if (!comment) return alert("ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”");

            const res = await fetch("/comment/add", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({diaryId, comment, parentId: null}),
                credentials: 'include'
            });

            if (res.ok) {
                document.getElementById("commentInput").value = "";
                loadComments(diaryId);
            } else {
                alert("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨");
            }
        });

        // ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadComments(diaryId) {
            const listContainer = document.getElementById("commentList");
            listContainer.innerHTML = "<p class='text-muted small'>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>";

            const res = await fetch(`/comment/list/${diaryId}`, {credentials: 'include'});
            if (res.ok) {
                const comments = await res.json();
                listContainer.innerHTML = "";
                console.log("ëŒ“ê¸€ ë°ì´í„°: " + comments);
                renderComments(comments, listContainer);
            } else {
                listContainer.innerHTML = "<p class='text-danger small'>ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>";
            }
        }

        // ëŒ“ê¸€ ë Œë”ë§ (ì¬ê·€)
        function renderComments(comments, container, parentId = 0) {
            comments
                .filter(c => c.parentId == parentId)
                .forEach(c => {
                    const div = document.createElement("div");
                    div.classList.add("mb-2", "border", "p-2", "rounded");
                    div.style.marginLeft = parentId ? "20px" : "0";

                    div.innerHTML = `
                <div class="d-flex justify-content-between">
                                <strong>${c.nickname}</strong>
                                <small class="text-muted">${new Date(c.createdAt).toLocaleString()}</small>
                </div>
                <div>${c.comment}</div>
                <div class="mt-1">
                    <button type="button" class="btn btn-sm btn-outline-secondary reply-btn" data-id="${c.commentId}">ë‹µê¸€</button>
                    ${c.userId === currentUser ? `
                        <button type="button" class="btn btn-sm btn-outline-warning edit-btn" data-id="${c.commentId}">ìˆ˜ì •</button>
                        <button type="button" class="btn btn-sm btn-outline-danger delete-btn" data-id="${c.commentId}">ì‚­ì œ</button>
                    ` : ""}
                </div>
                <div class="edit-form mt-2" id="edit-form-${c.commentId}" style="display:none;">
                    <input type="text" class="form-control mb-1" value="${c.comment}">
                    <button type="button" class="btn btn-sm btn-primary">ì €ì¥</button>
                </div>
            `;

                    container.appendChild(div);

                    renderComments(comments, container, c.commentId);
                });
        }

        document.getElementById("commentList").addEventListener("click", async (e) => {
            if (e.target.classList.contains("edit-btn")) {
                const id = e.target.dataset.id;
                const form = document.getElementById(`edit-form-${id}`);
                form.style.display = form.style.display === "none" ? "block" : "none";
            }
            if (e.target.matches(".edit-form button")) {
                const form = e.target.closest(".edit-form");
                const id = form.id.split("-")[2];
                const input = form.querySelector("input");
                const comment = input.value.trim();
                const diaryId = document.getElementById("diaryId").value;
                if (!comment) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");

                const res = await fetch(`/comment/update/${id}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ comment }),
                    credentials: "include"
                });

                if (res.ok) {
                    alert("ëŒ“ê¸€ ìˆ˜ì • ì™„ë£Œ!");
                    loadComments(diaryId);
                } else {
                    alert("ìˆ˜ì • ì‹¤íŒ¨");
                }
            }
            if (e.target.classList.contains("reply-btn")) {
                const id = e.target.dataset.id;
                const form = document.getElementById(`reply-form-${id}`);
                if (form) {
                    form.style.display = form.style.display === "none" ? "block" : "none";
                }
            }

            if (e.target.matches(".reply-form button")) {
                const form = e.target.closest(".reply-form");
                const parentId = form.id.split("-")[2];
                const input = form.querySelector("input");
                const comment = input.value.trim();
                const diaryId = document.getElementById("diaryId").value;

                if (!comment) return alert("ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”");

                const res = await fetch("/comment/add", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({diaryId, comment, parentId}),
                    credentials: "include"
                });

                if (res.ok) {
                    input.value = "";
                    loadComments(diaryId); // ğŸ”„ ëŒ“ê¸€ ê°±ì‹ 
                } else {
                    alert("ë‹µê¸€ ë“±ë¡ ì‹¤íŒ¨");
                }
            }

            if (e.target.classList.contains("delete-btn")) {
                const id = e.target.dataset.id;
                if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                const diaryId = document.getElementById("diaryId").value;

                const res = await fetch(`/comment/delete/${id}`, {
                    method: "POST",
                    credentials: "include"
                });

                if (res.ok) {
                    loadComments(diaryId);
                } else {
                    alert("ì‚­ì œ ì‹¤íŒ¨");
                }
            }
        });

    });


</script>
</body>
</html>