<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title><!DOCTYPE html>
        <html lang="en"
        xmlns:th="http://www.thymeleaf.org"
        xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
        <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js'></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>

        <head>
        <meta charset="UTF-8">
        <title>ğŸ§‘ğŸ»â€â¤ï¸â€ğŸ§‘ğŸ»coupleDiaryğŸ§‘ğŸ»â€â¤ï¸â€ğŸ§‘ğŸ»</title>
    <style>
        body {
            width:80%;
            height:40%;
            margin :100px auto;
            background: #f5f5f5;
        }

        /* ì „ì²´ ë ˆì´ì•„ì›ƒ */
        .main-layout {
            display: flex;
            width: 100%;
            height: 100vh;
            background: #fff;
            border: 1px solid #ccc;
            box-shadow: 0 0 15px rgba(246, 173, 208, 0.8), /* í•‘í¬ë¹› ë„¤ì˜¨ */
            0 0 30px rgba(255, 182, 193, 0.6),
            0 0 45px rgba(255, 192, 203, 0.4);
            border-radius: 8px; /* ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ (ì„ íƒ) */
            overflow: hidden;   /* ë‚´ë¶€ ìš”ì†Œê°€ ì‚ì ¸ë‚˜ê°€ì§€ ì•Šë„ë¡ */
            margin: 20px;       /* í™”ë©´ í…Œë‘ë¦¬ì™€ ì•½ê°„ ë„ì›€ */
            border-radius: 80px;
        }

        /* ë‹¬ë ¥ ì˜ì—­ */
        #calendar {
            flex: 1; /* ë‚¨ì€ ê³µê°„ ë‹¤ ì°¨ì§€ */
            /*border: 1px solid #000;*/
            min-height: 600px;
            background: white;
            margin: 30px;
        }

        /* ì˜¤ë¥¸ìª½ í”„ë¡œí•„ ì˜ì—­ */
        .profile-box {
            width: 200px; /* ì˜¤ë¥¸ìª½ ì˜ì—­ ê³ ì • */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #fff;
            border-left: 3px solid #ddd;
            padding: 20px;
            gap: 30px;
        }

        .profile {
            text-align: center;
        }

        .profile img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            background: #0d5c75; /* ëŒ€ì²´ ìƒ‰ìƒ */
        }

        .heart {
            font-size: 40px;
            color: crimson;
        }

        .fc-event {
            background-color: #f68bb5 !important;
            border: none !important;
            color: white !important;
            font-size: 12px;
            padding: 2px;
            border-radius: 6px;
        }
    </style>

</head>
<body>
<div id="body-frame"> <!-- ë¡œê·¸ì¸ ì•ˆ í•œ ì‚¬ìš©ì -->
    <a href="/loginPage" sec:authorize="isAnonymous()">ë¡œê·¸ì¸</a> <!-- ë¡œê·¸ì¸ í•œ ì‚¬ìš©ì -->
    <a href="/logout" sec:authorize="isAuthenticated()">ë¡œê·¸ì•„ì›ƒ</a>
</div>

<div class="main-layout">
    <!-- ë‹¬ë ¥ -->
    <div id="calendar"></div>

    <!-- ì˜¤ë¥¸ìª½ í”„ë¡œí•„ ë°•ìŠ¤ -->
    <div class="profile-box">
        <div class="profile">
            <img src="https://via.placeholder.com/80" />
            <div>ì´ë¦„1</div>
        </div>
        <div class="heart">â¤</div>
        <div class="profile">
            <img src="https://via.placeholder.com/80" />
            <div>ì´ë¦„2</div>
        </div>
    </div>
</div>
<div class="modal fade" id="diaryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form id="diaryForm" class="modal-content">
            <div class="modal-header"><h5 class="modal-title">ì¼ê¸° ì‘ì„± <span id="modalDateLabel"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body"><input type="hidden" id="diaryId"/> <input type="hidden" id="diaryDate"/>
                <div class="mb-3"><label class="form-label">ë‚ ì”¨</label> <input id="weatherInput" class="form-control"/>
                </div>
                <div class="mb-3"><label class="form-label">ê¸°ì˜¨</label> <input id="tempInput" type="number" step="0.1"
                                                                              class="form-control"/></div>
                <div class="mb-3"><label class="form-label">ê¸°ë¶„</label> <select id="moodInput" class="form-select">
                    <option value="">ì„ íƒ</option>
                    <option>ì¢‹ìŒ</option>
                    <option>ë³´í†µ</option>
                    <option>ë‚˜ì¨</option>
                </select></div>
                <div class="mb-3"><label class="form-label">ë‚´ìš©</label> <textarea id="contentInput" rows="6"
                                                                                 class="form-control"></textarea></div>
            </div>
            <div class="modal-footer">
                <button type="button" id="deleteBtn" class="btn btn-danger" style="display:none">ì‚­ì œ</button>
                gg
                <button type="submit" class="btn btn-primary">ì €ì¥</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
            </div>
        </form>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        const modal = new bootstrap.Modal(document.getElementById('diaryModal'));

        async function isAuthenticated() {
            const res = await fetch("/CheckAuth", {
                method: 'GET',
                credentials: 'include', // ì¿ í‚¤ ìë™ í¬í•¨ (JWTê°€ ì¿ í‚¤ì— ìˆìœ¼ë‹ˆê¹Œ í•„ìˆ˜)
                headers: {'Accept': 'application/json'}
            });
            console.log("[CheckAuth]:  " + res.status);
            return res.ok;
        }

        // form inputs
        const idInput = document.getElementById('diaryId');
        const dateInput = document.getElementById('diaryDate');
        const dateLabel = document.getElementById('modalDateLabel');
        const weatherInput = document.getElementById('weatherInput');
        const tempInput = document.getElementById('tempInput');
        const moodInput = document.getElementById('moodInput');
        const contentInput = document.getElementById('contentInput');
        const deleteBtn = document.getElementById('deleteBtn');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            events:'/diary/events',
            eventDisplay: 'block',     // ì¹¸ ì•ˆì— í…ìŠ¤íŠ¸ë¡œ í‘œì‹œ
            eventTextColor: '#fff',    // ê¸€ì”¨ìƒ‰
            eventBackgroundColor: '#f68bb5', // ë°°ê²½ìƒ‰ (í•‘í¬)
            eventClick: function(info) {
                // í´ë¦­í–ˆì„ ë•Œ ìƒì„¸ ëª¨ë‹¬ ë„ìš°ê¸°
                const diaryId = info.event.id;
                fetch(`/diary/${diaryId}`)
                    .then(res => res.json())
                    .then(diary => {
                        dateLabel.textContent = diary.date;
                        dateInput.value = diary.date;
                        idInput.value = diary.id;
                        contentInput.value = diary.content;
                        moodInput.value = diary.mood;
                        tempInput.value = diary.temperature;
                        weatherInput.value = diary.weather;
                        deleteBtn.style.display = 'block';
                        modal.show();
                    });
            },
            dateClick: async (info) => {
                const authed = await isAuthenticated();
                if (!authed) {
                    if (confirm("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤. ë¡œê·¸ì¸í˜ì´ì§€ë¡œ ì´ë™í• ê¹Œìš”?")) {
                        location.href = "/loginPage";
                    }
                    return;
                }
                //ê¸€ ìˆëŠ” ì§€ ì—†ëŠ”ì§€ ì—¬ë¶€ë„ ì²´í¬
                const clickedDate = info.dateStr; // YYYY-MM-DD
                console.log("cc"+clickedDate);
                dateLabel.textContent = clickedDate;
                dateInput.value = clickedDate;
                idInput.value = '';
                deleteBtn.style.display = 'none';
                contentInput.value = '';
                moodInput.value = '';
                tempInput.value = '';
                weatherInput.value = '';

                //ì„œë²„ì—ì„œ ë‚ ì”¨ ì •ë³´ê°€ì ¸ì˜¤ê¸°
                try {
                    const w = await fetch(`/diary/getWeather?date=${clickedDate}`, {
                        credentials: 'include',

                    });
                    console.log(clickedDate);
                    if (w.ok) {
                        const data = await w.json();
                        console.log("ê°€ì ¸ì˜¨ ë°ì´í„°" + data);

                        // 1) OpenWeatherMap ì›ë³¸(JSON) í˜•íƒœ ëŒ€ì‘
                        const owWeather = data?.weather?.[0]?.main;
                        const owTempK = data?.main?.temp;
                        const owTempC = typeof owTempK === 'number' ? +(owTempK - 273.15).toFixed(1) : null;


                        // 2) ì„œë²„ê°€ DateWeather/DTOë¡œ ë‚´ë ¤ì¤„ ìˆ˜ë„ ìˆì„ ë•Œ(ë°±ì—”ë“œê°€ ë°”ë€Œì–´ë„ ì•ˆì „í•˜ê²Œ)
                        const dtoWeather = data?.weather || data?.main;      // ex) "Clear" or "Clouds"
                        const dtoTempC = (typeof data?.temperature === 'number') ? data.temperature
                            : (typeof data?.temp === 'number') ? data.temp
                                : null;


                        // 3) ìµœì¢… ê°’ ì„ íƒ(ì›ë³¸ ìš°ì„ , ì—†ìœ¼ë©´ DTO ê°’)
                        const weatherVal = owWeather ?? dtoWeather ?? 'ì •ë³´ì—†ìŒ';
                        const tempVal = (owTempC ?? dtoTempC);

                        weatherInput.value = weatherVal;
                        tempInput.value = (tempVal != null) ? tempVal : 'ì •ë³´ì—†ìŒ';
                    }

                } catch (err) {
                    console.log(err);
                    alert("ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤");
                }
                modal.show();
            }
        });
        calendar.render();


        document.getElementById("diaryForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const diaryData = {
                date: dateInput.value,
                weather: weatherInput.value,
                temperature: parseFloat(tempInput.value) || 0,
                mood: moodInput.value,
                content: contentInput.value
            };

            try {
                const res = await fetch("/diary/save", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(diaryData),
                    credentials: 'include'
                });

                if (res.ok) {
                    alert("ì €ì¥ ì„±ê³µ!");
                    modal.hide();
                    calendar.refetchEvents(); // ì´ë²¤íŠ¸ ë‹¤ì‹œ ë¡œë“œ
                } else {
                    alert("ì €ì¥ ì‹¤íŒ¨");
                }
            } catch (err) {
                console.error(err);
                alert("ì—ëŸ¬ ë°œìƒ!");
            }
        });

    });


</script>
</body>
</html></title>
</head>
<body>

</body>
</html>